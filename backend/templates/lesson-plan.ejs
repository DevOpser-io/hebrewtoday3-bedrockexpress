<!-- EJS Lesson Plan Template -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lesson <%= lessonNumber %> | Hebrew Today</title>
  <link rel="icon" href="/static/icon.png" type="image/png">
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="/static/css/litera-bootstrap.min.css">
  
  <!-- Critical inline styles for lesson plan -->
  <style nonce="<%= cspNonce %>">
    .lesson-item {
      background: transparent;
      border: none;
      padding: 0.5rem 1rem;
      display: block;
      text-align: left;
      width: 100%;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      transition: background-color 0.2s ease;
    }
    .lesson-item:hover {
      background-color: rgba(0,0,0,0.05);
    }
    .lesson-item.active {
      background-color: #007bff;
      color: white;
    }
    .lesson-group-header {
      font-size: 0.9rem;
      color: #6c757d;
      padding: 0.75rem 1rem 0.25rem 1rem;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    .flashcard-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      padding: 2rem;
    }
    .flashcard {
      max-width: 500px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: hidden;
      background: white;
    }
    .flashcard img {
      width: 100%;
      height: auto;
      display: block;
    }
    .fallback-image {
      width: 100%;
      height: 300px;
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .lesson-header {
      text-align: center;
      padding: 2rem 1rem 1rem 1rem;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      margin-bottom: 2rem;
    }
    .lesson-title {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }
    .lesson-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin: 0.5rem 0 0 0;
    }
  </style>
  
  <!-- Remaining CSS Files -->
  <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/nav.css">
  <link rel="stylesheet" href="/static/flash.css">
  <link rel="stylesheet" href="/static/dist/bundle.css">
  <link rel="stylesheet" href="/static/chat-custom.css">
  
  <!-- JavaScript Files -->
  <script src="/static/js/bootstrap.bundle.min.js" defer></script>
  <script src="/static/flash.js" defer></script>
  <script src="/static/csrf.js" defer></script>
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Hebrew Today</a>
        
        <!-- hamburger toggler -->
        <button 
          class="navbar-toggler" 
          type="button" 
          data-bs-toggle="collapse" 
          data-bs-target="#navbarNav" 
          aria-controls="navbarNav" 
          aria-expanded="false" 
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <%- include('./partials/nav') %>
      </div>
    </nav>
  </header>

  <main class="container-fluid p-0">
    <div class="row app-container m-0">
      <!-- Sidebar for lesson navigation -->
      <div class="sidebar">
        <div class="sidebar-content">
          <div class="sidebar-header">
            <span>Lessons</span>
            <a href="/chat" class="new-chat-btn" style="text-decoration: none; color: white;">Back to Chat</a>
          </div>
          <div class="lesson-list">
            <div class="lesson-group-header">Hebrew Today Lessons</div>
            <% for (let i = 1; i <= 18; i++) { %>
              <button 
                type="button" 
                class="lesson-item <%= i == lessonNumber ? 'active' : '' %>" 
                data-lesson="<%= i %>"
                onclick="selectLesson(<%= i %>)"
              >
                Lesson <%= i %>
              </button>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- Lesson content area -->
      <div class="chat-area">
        <!-- Lesson header -->
        <div class="lesson-header">
          <h1 class="lesson-title">Lesson <%= lessonNumber %></h1>
          <p class="lesson-subtitle">Hebrew Language Learning</p>
        </div>

        <!-- Flashcard container -->
        <div class="flashcard-container">
          <div class="flashcard">
            <img 
              id="flashcard-image" 
              src="/api/lesson/<%= lessonNumber %>/flashcard" 
              alt="Lesson <%= lessonNumber %> Flashcard"
              style="display: none;"
              onload="showFlashcard()"
              onerror="showFallback()"
            />
            <div id="fallback-image" class="fallback-image">
              <span>Image Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Lesson navigation script -->
  <script nonce="<%= cspNonce %>">
    let currentLesson = <%= lessonNumber %>;
    
    function selectLesson(lessonNumber) {
      if (lessonNumber === currentLesson) return;
      
      // Update URL and reload
      window.location.href = `/chat?mode=lesson&lesson=${lessonNumber}`;
    }
    
    function showFlashcard() {
      const image = document.getElementById('flashcard-image');
      const fallback = document.getElementById('fallback-image');
      
      image.style.display = 'block';
      fallback.style.display = 'none';
    }
    
    function showFallback() {
      const image = document.getElementById('flashcard-image');
      const fallback = document.getElementById('fallback-image');
      
      image.style.display = 'none';
      fallback.style.display = 'flex';
      fallback.innerHTML = '<span>Image not available</span>';
    }
    
    // Preload next/previous lesson images for smooth navigation
    function preloadAdjacentLessons() {
      const nextLesson = currentLesson < 18 ? currentLesson + 1 : null;
      const prevLesson = currentLesson > 1 ? currentLesson - 1 : null;
      
      [nextLesson, prevLesson].forEach(lesson => {
        if (lesson) {
          const img = new Image();
          img.src = `/api/lesson/${lesson}/flashcard`;
        }
      });
    }
    
    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft' && currentLesson > 1) {
        selectLesson(currentLesson - 1);
      } else if (e.key === 'ArrowRight' && currentLesson < 18) {
        selectLesson(currentLesson + 1);
      }
    });
    
    // Initialize
    window.addEventListener('load', function() {
      preloadAdjacentLessons();
    });
  </script>
  
  <!-- Load remaining JavaScript -->
  <script src="/static/js/navbar-debug.js"></script>
  <script src="/static/js/mobile-nav.js"></script>
</body>
</html>